image: shipito/php:7.1

stages:
  - build
  - analyze
  - test

build:
  stage: build

  script:
  - mkdir images
  - mkdir images/maps
  - mkdir temp/cache
  - mkdir temp/sessions
  - composer install --prefer-dist -a

  cache:
    paths:
    - vendor/

  artifacts:
    paths:
    - vendor
    - images
    - temp/cache
    - temp/sessions
    expire_in: 10 mins

analyze:lint:
  stage: analyze

  script:
  - ./vendor/bin/parallel-lint . -e php,phpt --exclude vendor --exclude temp

analyze:cs:
  stage: analyze

  before_script:
  - curl https://gitlab.com/heroesofabenez/resources/raw/master/cs-ruleset.xml > cs-ruleset.xml

  script:
  - ./vendor/bin/phpcs --extensions=php,phpt . --standard=cs-ruleset.xml --colors

.job_template: &test_job
  stage: test

  services:
  - mysql

  variables:
    MYSQL_DATABASE: heroesofabenez
    MYSQL_ROOT_PASSWORD: root

  before_script:
  - php ci/setup_db.php

  script:
  - php run_tests.php

test:default:
  <<: *test_job
